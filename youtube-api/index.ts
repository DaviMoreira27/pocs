import { google } from "googleapis";
import fs from "fs";
import path from "path";
import open from "open";

const SCOPES = [
  "https://www.googleapis.com/auth/youtube.force-ssl",
  "https://www.googleapis.com/auth/youtubepartner",
];
const CREDENTIALS_PATH = path.resolve("credentials.json");
const TOKEN_PATH = path.resolve("token.json");

async function authorize() {
  const credentials = JSON.parse(fs.readFileSync(CREDENTIALS_PATH, "utf-8"));
  const { client_id, client_secret, redirect_uris } = credentials.installed;

  const oAuth2Client = new google.auth.OAuth2(
    client_id,
    client_secret,
    redirect_uris[0],
  );

  if (fs.existsSync(TOKEN_PATH)) {
    oAuth2Client.setCredentials(
      JSON.parse(fs.readFileSync(TOKEN_PATH, "utf-8")),
    );
    return oAuth2Client;
  }

  const authUrl = oAuth2Client.generateAuthUrl({
    access_type: "offline",
    scope: SCOPES,
  });

  console.log("Autorize o app:", authUrl);
  await open(authUrl);

  const code = await new Promise<string>((resolve) => {
    process.stdin.once("data", (data) => resolve(data.toString().trim()));
  });

  const { tokens } = await oAuth2Client.getToken(code);
  oAuth2Client.setCredentials(tokens);

  fs.writeFileSync(TOKEN_PATH, JSON.stringify(tokens, null, 2));
  return oAuth2Client;
}

async function downloadCaption(
  youtube: ReturnType<typeof google.youtube>,
  captionId: string,
) {
  console.log(`CAPTION ID: ${captionId}`);
  const res = await youtube.captions.download(
    {
      id: captionId,
      // tfmt: "xml", // xml | srt | vtt
    },
    { responseType: "stream" },
  );

  const output = fs.createWriteStream(`caption-${captionId}.xml`);

  await new Promise<void>((resolve, reject) => {
    res.data
      .on("end", () => resolve())
      .on("error", reject)
      .pipe(output);
  });

  console.log("Legenda baixada com sucesso.");
}

async function listCaptions(videoId: string) {
  const auth = await authorize();
  const youtube = google.youtube({ version: "v3", auth });

  const res = await youtube.captions.list({
    part: ["snippet"],
    videoId,
  });

  if (!res.data.items || res.data.items.length === 0) {
    console.log("Nenhuma caption encontrada.");
    return;
  }

  for (const caption of res.data.items) {
    const info = {
      id: caption.id!,
      language: caption.snippet?.language,
      name: caption.snippet?.name,
      isAutoGenerated: caption.snippet?.trackKind,
      status: caption.snippet?.status,
    };

    console.log("RESPONSE", info);

    console.log(`STARTING DOWNLOADING`);
    await downloadCaption(youtube, info.id);
  }
}

listCaptions("hjKZNSyzmTE").catch(console.error);
